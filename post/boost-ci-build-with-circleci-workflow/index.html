<!DOCTYPE html>
<html lang="zh-tw">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta content="" name="keywords">
<meta content="CiricleCI Workflow: è®“ build æ™‚é–“æ¸›å°‘ 50% çš„è¨­å®šå¿ƒå¾— - HzChris" property="og:title">
<title>CiricleCI Workflow: è®“ build æ™‚é–“æ¸›å°‘ 50% çš„è¨­å®šå¿ƒå¾— | HzChris</title>
<link rel="stylesheet" href="https://blog.hzchris.space/css/style.css">
<link rel="stylesheet" href="https://blog.hzchris.space/css/custom.css">
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">


<body>
<header>
  <section class="section">
    <div class="container">
      <nav class="nav">
        <div class="nav-left">
          <a class="nav-item" href="https://blog.hzchris.space"><h1 class="title is-4">HzChris</h1></a>
        </div>
        <div class="nav-right">
          <nav class="nav-item level is-mobile">
            
            <a class="level-item" href="https://github.com/hzchirs">
              <span class="icon">
                <i class="fa fa-github"></i>
              </span>
            </a>
            
            <a class="level-item" href="https://www.facebook.com/hzchirs">
              <span class="icon">
                <i class="fa fa-facebook-square"></i>
              </span>
            </a>
            
          </nav>
        </div>
      </nav>
    </div>
  </section>
</header>

<section class="section">
  <div class="container">
    <h2 class="subtitle is-6">June 16, 2018</h2>
    <h1 class="title">CiricleCI Workflow: è®“ build æ™‚é–“æ¸›å°‘ 50% çš„è¨­å®šå¿ƒå¾—</h1>
    
      <div class="tags">
    
        <a class="button is-link" href="/tags/ci">CI</a>
    
        <a class="button is-link" href="/tags/workflow">Workflow</a>
    
</div>

    
    <div class="content">
      

<p><a href="https://statementdog.com/">è²¡å ±ç‹—</a>ç”¨ CircleCI æœ‰ä¸€æ®µæ™‚é–“äº†ï¼Œä¸€é–‹å§‹ç”¨çš„æ™‚å€™é‚„æ˜¯ 1.0ï¼Œ2.0 é‚„åœ¨ beta éšæ®µã€‚æˆ‘å€‘çš„å°ˆæ¡ˆåœ¨ 1.0 ä¸Šé¢ä¸€ç›´é‹ä½œè‰¯å¥½ï¼Œæ‰€ä»¥ä¹Ÿæ²’æœ‰æƒ³èªªè¦æ›ï¼Œç›´åˆ° CircleCI ç™¼ä½ˆ 2018/8/31 ä¹‹å¾Œå°‡ä¸å†æ”¯æ´ 1.0ï¼Œæˆ‘å€‘æ‰é–‹å§‹è€ƒæ…®è¦é·ç§»å°ˆæ¡ˆ XDï¼Œé †ä¾¿è¶ç€é€™æ¬¡çš„é·ç§»å°å…¥çš„ 2.0 çš„æ–°åŠŸèƒ½: <strong>workflow</strong>ã€‚</p>

<h2 id="workflow-ç°¡ä»‹">Workflow ç°¡ä»‹</h2>

<p>CircleCI åœ¨ 2.0 ä¸­æ¨å‡ºäº† workflow é€™å€‹æ–°åŠŸèƒ½ï¼Œå®˜ç¶²çš„ä»‹ç´¹å¦‚ä¸‹ï¼š</p>

<blockquote>
<p>A workflow is a set of rules for defining a collection of jobs and their run order. Workflows support complex job orchestration using a simple set of configuration keys to help you resolve failures sooner.</p>
</blockquote>

<p>ç°¡å–®ä¾†èªªï¼Œworkflow æä¾›äº†ä¸€ç¨®åšæ³•ï¼Œè®“ä½ å¯ä»¥æŠŠ CI çš„æ¯å€‹æ­¥é©Ÿæ‹†åˆ†æˆä¸€å€‹å€‹ç¨ç«‹çš„ jobsï¼Œjobs ä¹‹é–“éµç…§ä¸€å®šçš„åŸ·è¡Œé †åºæˆ–æ˜¯ä¸¦è¡Œï¼Œè¬ä¸€ç™¼ç”Ÿå¤±æ•—ï¼Œåªè¦é‡å°å¤±æ•—çš„ job å»åšè™•ç†å°±å¥½äº†ï¼Œå¤§å¤§æå‡åæ‡‰é€Ÿåº¦ã€‚</p>

<h2 id="workflow-è§£æ±ºäº†ä»€éº¼å•é¡Œ">Workflow è§£æ±ºäº†ä»€éº¼å•é¡Œï¼Ÿ</h2>

<ol>
<li><p>èˆŠæœ‰çš„ CI æµç¨‹éƒ½æ˜¯å¾ªåºçš„ï¼Œåƒæ˜¯å¿…é ˆè¦åŸ·è¡Œå®Œ <code>bundle install</code> æ‰å¯ä»¥ç¹¼çºŒ <code>yarn
install</code>ï¼Œä½†æ˜¯é€™å…©å€‹ job å½¼æ­¤é–“ä¸¦æ²’æœ‰ç›¸ä¾æ€§ï¼Œåœ¨ workflow ä¸­ï¼Œå¯ä»¥è¨­è¨ˆè®“æ²’æœ‰ç›¸ä¾çš„
job ä¸¦è¡Œï¼Œcontainer è¶Šå¤šï¼Œå¯ä»¥ä¸¦è¡Œçš„ job ä¹Ÿå°±è¶Šå¤šã€‚</p></li>

<li><p>ç”¨å¾ªåºçš„æ–¹å¼åŸ·è¡Œ jobï¼Œåªè¦å…¶ä¸­ä¸€å€‹ job å¤±æ•—ï¼Œå°±éœ€è¦æ•´å€‹ CI é‡ä¾†ï¼›è€Œ workflow ä¸­çš„æ¯ä¸€å€‹ job å½¼æ­¤æ˜¯ç¨ç«‹çš„ï¼Œå¯ä»¥åªé‡å°å¤±æ•—çš„ job é‡è·‘å³å¯ã€‚</p></li>
</ol>

<h2 id="workflow-è¨­å®š">Workflow è¨­å®š</h2>

<p>åœ¨ä½¿ç”¨ Workflow ä¹‹å‰ï¼Œéœ€è¦å…ˆæƒ³å¥½å°ˆæ¡ˆçš„ CI æµç¨‹å¯ä»¥ç¨ç«‹æˆå“ªå¹¾å€‹æ­¥é©Ÿï¼›ä»¥è²¡å ±ç‹—å°ˆæ¡ˆä¾†
èªªï¼Œå¯ä»¥åˆ†æˆä»¥ä¸‹å¹¾å€‹ï¼š</p>

<ul>
<li><p><strong>a. checkout_code</strong>: å°‡ç¨‹å¼ç¢¼å¾é ç«¯ pull ä¸‹ä¾†ï¼Œåœ¨ CI ç’°å¢ƒä¸­åšå¥½è·¯å¾‘è¨­å®š</p></li>

<li><p><strong>b. bundle_dependencies</strong>: å®‰è£ rails application ç›¸ä¾æ€§å¥—ä»¶</p></li>

<li><p><strong>c. yarn_dependencies</strong>: å®‰è£å‰ç«¯ç›¸ä¾æ€§å¥—ä»¶</p></li>

<li><p><strong>d. run_unit_test</strong>: åŸ·è¡Œå–®å…ƒæ¸¬è©¦</p></li>

<li><p><strong>e. run_integration_test</strong>: åŸ·è¡Œæ•´åˆæ¸¬è©¦</p></li>

<li><p><strong>f. deploy</strong>: å°‡ç¨‹å¼ä½ˆç½²åˆ° production</p></li>
</ul>

<p>ä»¥å¾ªåºçš„æ–¹å¼å»è·‘ï¼Œå¤§ç´„éœ€è¦èŠ± 16 åˆ†é˜</p>

<p><img src="/img/ci-1-build.png" alt="CI 1.0 build" /></p>

<p>æ¯æ¬¡éƒ½å¾ªåºè·‘å¯¦åœ¨æœ‰é»æ²’æ•ˆç‡ï¼Œä»¥ä¸Šé¢çš„æµç¨‹ä¾†èªªï¼Œ <code>bundle_dependencies</code>ã€
<code>yarn_dependencies</code> å¯ä»¥åœ¨ <code>checkout_code</code> çµæŸä¹‹å¾ŒåŒæ™‚åŸ·è¡Œï¼› <code>run_unit_test</code> ä»¥åŠ
<code>run_integration_test</code> å‰‡æ˜¯åœ¨ dependencies å®‰è£çµæŸä¹‹å¾Œå°±å¯ä»¥ä¸¦è¡Œï¼Œé€™ä¹Ÿå°±æ˜¯ workflow æœ€ä¸»è¦çš„åŠŸèƒ½ï¼Œåœ¨ CI ä¸­åªè¦å®šç¾©å¥½æ¯ä¸€å€‹ job ï¼Œå°±å¯ä»¥å¾ˆè¼•æ˜“çš„è¨­å®šå¥½ workflowï¼š</p>

<pre><code class="language-ruby">workflows:
  version: 2
  build_and_test: # Workflow çš„åç¨±
    jobs:
      - checkout_code
      - bundle_dependencies:
          requires: # ç›¸ä¾æ–¼å“ªäº› jobs
            - checkout_code
      - yarn_dependencies:
          requires:
            - checkout_code
      - run_unit_tests:
          requires:
            - bundle_dependencies
      - run_integration_tests:
          requires:
            - yarn_dependencies
            - bundle_dependencies
      - deploy:
          requires:
            - run_unit_tests
            - run_integration_tests
</code></pre>

<p>è¨­å®šå¥½ä¹‹å¾Œï¼ŒCircleCI å°±æœƒè‡ªå‹•ä»¥ workflow çš„æ–¹å¼åŸ·è¡Œï¼š</p>

<p><img src="/img/workflow.png" alt="workflow" /></p>

<p>ç´…è‰²æ¡†æ¡†åœˆèµ·ä¾†çš„æ˜¯ä¸¦è¡ŒåŸ·è¡Œçš„éƒ¨åˆ†ï¼Œå¯ä»¥çœ‹åˆ°æœ€èŠ±æ™‚é–“çš„ <code>run_unit_test</code> ä»¥åŠ <code>run_integration_test</code> å› çˆ²ä¸¦è¡Œçš„é—œä¿‚ï¼ŒåªèŠ±äº† 6 åˆ†é˜å°±è·‘å®Œäº†ï¼Œè€Œæ•´å€‹ CI çš„æ™‚é–“å‰‡è¶³è¶³å¾ 16 åˆ†é˜ç¸®çŸ­åˆ° 7 åˆ†å¤šé˜ï¼Œé€Ÿåº¦è®Šå¿«è¶…æœ‰æ„Ÿçš„é˜¿ï¼</p>

<h2 id="é‡è·‘-workflow-å¤±æ•—çš„-jobs">é‡è·‘ workflow å¤±æ•—çš„ jobs</h2>

<p>å‰›å‰›æåˆ° workflow çš„å¥½è™•é™¤äº†ä¸¦è¡Œç¸®çŸ­åŸ·è¡Œæ™‚é–“å¤–ï¼Œé‚„æœ‰ä¸€é»å°±æ˜¯å¯ä»¥åªé‡è·‘å¤±æ•—çš„ jobï¼Œè€Œä¸éœ€è¦é‡è·‘æ•´å€‹ CIã€‚</p>

<p>çˆ²ä»€éº¼é€™å¾ˆé‡è¦å‘¢ï¼Ÿåœ¨è·‘ CI çš„æ™‚å€™ï¼Œå¶çˆ¾æœƒé‡åˆ°ä¸€äº› random failsï¼Œåƒæ˜¯ç¶²è·¯çªç„¶ä¸ç©©
ï¼Œæˆ–æ˜¯å¥—ä»¶å®‰è£å› çˆ²ä¸æ˜åŸå› å¤±æ•—ç­‰ç­‰ï¼Œåƒä¸‹é¢é€™æ¨£ï¼š</p>

<p><img src="/img/workflow-failed.png" alt="deploy éšæ®µéŒ¯èª¤" /></p>

<p>ä»”ç´°æª¢æŸ¥æœƒç™¼ç¾æ˜¯ deploy éšæ®µåœ¨ ssh connect åˆ° server çš„éç¨‹ä¸­ timeout äº†ï¼Œé€™å¯èƒ½æ˜¯ server é‚£é‚Šè¨­å®šå‡ºäº†é»å•é¡Œï¼Œé€šå¸¸é€™ç¨®æƒ…æ³åªè¦é€²åˆ° server æ”¹å¥½è¨­å®šï¼Œé‡è·‘ä¸€æ¬¡ CI å°±å¯ä»¥è§£æ±ºï¼Œä¸éå¦‚æœåªæ˜¯ deploy éšæ®µå‡ºéŒ¯ï¼Œé‡è·‘é‚„éœ€è¦é‡æ–°è¨­å®šç’°å¢ƒã€è£å¥—ä»¶ã€è·‘å®Œæ¸¬è©¦å¾Œæ‰å¯ä»¥ deployï¼Œå¯¦åœ¨å¤ªæ²’æ•ˆç‡äº†ï¼Œæ‰€ä»¥åœ¨ workflow ä¸­ï¼Œå¾ˆè²¼å¿ƒçš„è®“ä½ å¯ä»¥é¸æ“‡åªè·‘å¤±æ•—çš„ jobsï¼Œé€²ä¸€æ­¥çš„ç¯€çœæ™‚é–“ã€‚</p>

<p><img src="/img/workflow-rerun-failed.png" alt="only rerun failed jobs" /></p>

<h2 id="å…¶ä»–æ³¨æ„äº‹é …">å…¶ä»–æ³¨æ„äº‹é …</h2>

<h3 id="å–„ç”¨-cache">å–„ç”¨ Cache</h3>

<p>åœ¨ workflow ä¸­ï¼Œæ¯å€‹ job éƒ½æ˜¯é‹ä½œåœ¨ä¸€å€‹ç¨ç«‹çš„ container ç•¶ä¸­ï¼Œçˆ²äº†ç¢ºä¿æ¯å€‹ job å¯ä»¥ç¨ç«‹é‹è¡Œï¼Œæ‰€ä»¥å¯èƒ½æœƒéœ€è¦å‰ä¸€æ¬¡ CI æˆ–æ˜¯å‰ä¸€å€‹ job ç”¢ç”Ÿçš„ä¸€äº›è³‡æ–™ï¼Œåƒæ˜¯æ¯æ¬¡è·‘ <code>bundle install</code> æ™‚ï¼Œåªæƒ³è¦å®‰è£ä¹‹å‰æ²’è£éçš„ gem ï¼Œè€Œä¸æ˜¯æ•´åŒ…é‡è£ï¼Œæˆ–æ˜¯åƒæ˜¯è·‘æ¸¬è©¦æ™‚æœƒéœ€è¦ bundle è£å¥½çš„è³‡æ–™ï¼Œé€™æ™‚å€™å°±éœ€è¦ç”¨åˆ° cache äº†ã€‚</p>

<p>ä»¥ <code>bundle install</code> çˆ²ä¾‹ï¼Œè£å¥½çš„ bundle å¯ä»¥ç”¨ <code>save_cache</code> å„²å­˜èµ·ä¾†ï¼š</p>

<pre><code class="language-ruby">- save_cache:
    key: v1-gem-{{ checksum &quot;Gemfile.lock&quot; }}
    paths:
      - vendor/bundle
</code></pre>

<p>å¦‚æœä¹‹å¾Œçš„ job æˆ–æ˜¯ build éœ€è¦ç”¨åˆ°é€™åŒ…è£å¥½çš„ bundle ï¼Œåªéœ€è¦ <code>restore_cache</code> å³å¯ï¼š</p>

<pre><code class="language-ruby">restore_cache:
  keys:
    - v1-gem-{{ checksum &quot;Gemfile.lock&quot; }}
    - v1-gem-
</code></pre>

<p>é€™é‚Š CircleCI çµ¦äº†ä¸€å€‹å½ˆæ€§ï¼Œå¯ä»¥è¨­å®šå¤šçµ„ keyï¼Œ è¬ä¸€ä½¿ç”¨ç¬¬ä¸€å€‹ key (v1-gem-{{
checksum &ldquo;Gemfile.lock&rdquo; }}) æ‰¾ä¸åˆ°ç¬¦åˆçš„çµæœï¼Œå°±æœƒä½¿ç”¨ <code>v1-gem-</code> é€™å€‹ keyï¼Œå»æ¯”å°æœ€è¿‘
ç”¢ç”Ÿï¼Œä¸”å‰ç¶´ç¬¦åˆ <code>v1-gem-</code> çš„å¿«å–è³‡æ–™ã€‚</p>

<h3 id="ä¸è¦è¨­è¨ˆå¤ªå°çš„-job">ä¸è¦è¨­è¨ˆå¤ªå°çš„ job</h3>

<p>ç”±æ–¼æ¯å€‹ job åœ¨é‹ä½œä¹‹å‰ä»ç„¶éœ€è¦æº–å‚™å¥½æ‰€éœ€è¦çš„ç’°å¢ƒèˆ‡è³‡æ–™æ‰èƒ½å¤ é‹è¡Œï¼Œå³ä½¿æœ‰åšå¥½ cacheï¼Œå–å¾— cache çš„éç¨‹ä¸­ï¼Œåªè¦æª”æ¡ˆç¨å¤§ï¼Œä»ç„¶éœ€è¦èŠ±è²» 10 - 20 ç§’çš„æ™‚é–“ï¼Œå¦‚æœæ˜¯ä¸€å€‹ 30 ç§’å…§å°±å¯ä»¥åŸ·è¡Œå®Œçš„ commandï¼Œä¸å¤ªå»ºè­°æ‹‰å‡ºä¾†æˆçˆ²ä¸€å€‹ç¨ç«‹çš„ jobï¼Œåè€Œæœƒæ‹–æ…¢æ•´å€‹ CI çš„é€Ÿåº¦ã€‚</p>

<h2 id="æœ€å¾Œ">æœ€å¾Œ&hellip;</h2>

<p>é‚„æ˜¯å° workflow çš„è¨­å®šæœ‰äº›ä¸ç­è§£çš„è©±ï¼Œå¯ä»¥åˆ°æˆ‘çš„
<a href="https://gist.github.com/hzchirs/1040282e5b58df509155613c1d8dbee6">Gist</a> çœ‹è©³ç´°çš„è¨­å®š
ï¼Œæœ‰å•é¡Œæˆ–æ˜¯æœ‰ä»€éº¼ CI è¨­å®šä¸Šçš„å»ºè­°ï¼Œä¹Ÿæ­¡è¿ç•™è¨€è¨è«– ğŸ˜ƒã€‚</p>

    </div>
  </div>
</section>

<section class="section">
  <div class="container">
    <aside>
      <div id="disqus_thread"></div>
    </aside>
    <script type="text/javascript">
      var disqus_config = function () {
        this.page.url = 'https:\/\/blog.hzchris.space\/post\/boost-ci-build-with-circleci-workflow\/';  
        this.page.identifier = '\/post\/boost-ci-build-with-circleci-workflow\/'; 
      };

      var disqus_shortname = 'hzchris';
     
      (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>
</section>


<section class="section">
  <div class="container has-text-centered">
    <p>Copyright Â© 2018 by HzChris</p>
  </div>
</section>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/languages/ruby.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/languages/javascript.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/languages/vim.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/languages/shell-session.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/languages/bash.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/languages/zsh.min.js"></script>

<script>hljs.initHighlightingOnLoad();</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-103426647-1', 'auto');
  ga('send', 'pageview');

</script>

</body>
